<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
	<link id="stylecall1" rel="stylesheet" href="/css/academic_style.css" />
	<link id="stylecall2" rel="stylesheet" href="/css/logo_dadiu.css" />
	<link id="stylecall3" rel="stylesheet" href="/css/inputButton.css" />
	<link id="stylecall5" rel="stylesheet" href="/css/japanese.css" />
	<link id="stylecall4" rel="stylesheet" href="/css/piano.css" />
	<link id="stylecall4" rel="stylesheet" href="/css/fire.css" />
	<link id="stylecall4" rel="stylesheet" href="/css/spark.css" />
	<link rel="icon"
	  type="image/png"
	  href="/img/d01.png">
	  <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.scrollTo.js"></script>
		<script type="text/javascript" src="/js/audiosynth.js"></script>

</head>

<title>Dadiu | Piano</title>

<body onload="init()">
	<div id="head">
		<div id="logo">
			<img src="/img/dadiu.png" alt="dai01" class="logo_dadiu">
		</div>
	</div>

	<link rel="stylesheet" href="/css/responsive_bar_style.css">
	<div class="topnav" id="myTopnav">
	</div>
	<script>
	var namePassToFunction = [];
	var btnTopnavClicked = false;
	/* Toggle between adding and removing the "responsive" class to topnav when the user clicks on the icon */
	function myFunction() {
			if(btnTopnavClicked){
					btnTopnavClicked = false;
			}else{
					btnTopnavClicked = true;
			}

	    var x = document.getElementById("myTopnav");
	    if (x.className === "topnav") {
	        x.className += " responsive";
	    } else {
	        x.className = "topnav";
	    }
			pasteToBar(namePassToFunction, btnTopnavClicked);

			if(btnTopnavClicked){
					document.getElementById("myInput").focus();
			}
	}

	function loadPianoList(){
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function(){
				if(xmlhttp.status == 200 && xmlhttp.readyState == 4){
						namePassToFunction = [];
						var txt = xmlhttp.responseText;
						var arr = txt.split("\n");
						for(i = 0; i < arr.length; i++){
								var temp = arr[i].trim();
								if(temp != ""){
										namePassToFunction[namePassToFunction.length] = temp;
								}
						}
						namePassToFunction.sort();
						pasteToBar(namePassToFunction, false);
				}
			};
			xmlhttp.open("GET","./music/pianoList.txt",true);
			xmlhttp.send();
	}

	function inputFunction(){
			var inputChar = document.getElementById("myInput").value;
			var pianoList = document.getElementsByClassName("pianoList");
			for(i = 0; i < pianoList.length; i++){
					if(!pianoList[i].innerHTML.toLowerCase().includes(inputChar.toLowerCase())){
							pianoList[i].style.display = "none";
					}else{
							pianoList[i].style.display = "block";
					}
			}
	}

	function pasteToBar(arr, isDisplaySearchBar){
			var display = "none";
			if(isDisplaySearchBar){
					display = "block";
			}

			var result = '<a href="/">Home</a><input type="text" style ="display:'+display+'; width: 100%; font-size: 17px; background-color: #ebf3ff;;" placeholder="Search" id="myInput" oninput="inputFunction()">';
			for(i = 0; i < arr.length; i++){
					var functionName = arr[i];
					if(arr[i].includes("'")){
							functionName = encryptFileName(arr[i]);
					}
					result += '<a class="pianoList" onclick=\'loadSrc("'
									+ functionName
									+ '");\' class="other">'
									+ arr[i]
									+ '</a>';
			}
			result += '<a href="javascript:void(0);" class="icon" onclick="myFunction()">&#9776;</a></div>';
			document.getElementById("myTopnav").innerHTML = result;
	}
	</script>

	<!--TODO-->
	<div id="buttonBox">
			<button id="btnSetting" class="buttonJp btnFilter">Hide Setting</button>
			<button id="btnD" class="buttonJp btnFilter btnSetting">2-D</button>
			<button id="btnChangePerson" class="buttonJp btnFilter btnSetting">No. of Players : 1</button>
			<button id="btnSwitchPersonHand" class="buttonJp btnFilter btnSetting" disabled>Switch</button>
			<button id="btnPressDuration" class="buttonJp btnFilter btnSetting">Duration per time : 100 ms</button>
			<button id="btnFire" class="buttonJp btnFilter btnSetting">Fire : Off</button>
			<button id="btnSpark" class="buttonJp btnFilter btnSetting">Spark : Off</button>
		  <button id="btnPlay" class="buttonJp btnFilter" disabled>Play</button>
			<button id="btnStop" class="buttonJp btnFilter" disabled>Stop</button>
			<button id="btnPause" class="buttonJp btnFilter" disabled>Pause</button>
	</div>
	<div id="fileUploadDiv">
  		<input id="fileInput" type="file" name="file" />
	</div>
	<a id="downloadLink" style="display:none;">Download</a>
	<div id="displayPiano">
	</div>

  <pre style="display:none" id="fileContent"></pre>

	<script>
	var isEffectOn = true;
	var currentPlaySongName = "";
	var btnClickTimeout = [];
	var btnReleaseTimeout = [];
	var notePlayTimeout = [];

	// get timeDiff from play to another person start
	var start = new Date().getTime();
	var end = new Date().getTime();
	var timeDiff = end - start;
	// get timeDiff from play to another person end

	//btn click start
	var btnSetting = document.getElementById("btnSetting");
	var isSettingOn = true;
	btnSetting.onclick = function() {
			btnSetting.classList.add("active");
			isSettingOn = !isSettingOn;
			var btnSettingArr = document.getElementsByClassName("btnSetting");
			for(var i = 0; i < btnSettingArr.length; i++){
					if(isSettingOn){
							btnSettingArr[i].style.display = 'block';
					}else{
							btnSettingArr[i].style.display = 'none';
					}
			}
			if(isSettingOn){
					btnSetting.innerHTML = "Hide Setting";
			}else{
					btnSetting.innerHTML = "Show Setting";
			}
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnSetting.classList.remove("active");
			}, 150);
	}

	var btnPlay = document.getElementById("btnPlay");
	btnPlay.onclick = function() {
			btnPlay.classList.add("active");
			loadText(document.getElementById('fileContent').textContent);
			btnStop.disabled = false;
			btnStop.classList.remove("disabled");
			btnStop.classList.add("abled");
			btnPause.disabled = false;
			btnPause.classList.remove("disabled");
			btnPause.classList.add("abled");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnPlay.classList.remove("active");
			}, 150);
	}

	var btnD = document.getElementById("btnD");
	btnD.onclick = function() {
			btnD.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnD.classList.remove("active");
			}, 150);

			if(isPiano3D){
					btnD.innerHTML = "2-D";
			}else{
					btnD.innerHTML = "3-D";
			}
			isPiano3D = !isPiano3D;
			displayPiano();
	}

	var btnStop = document.getElementById("btnStop");
	btnStop.onclick = function() {
			btnStop.disabled = true;
			btnStop.classList.remove("abled");
			btnStop.classList.add("disabled");
			btnPause.disabled = true;
			btnPause.classList.remove("abled");
			btnPause.classList.add("disabled");
			clearAllTimeout();
			displayPiano();
	}

	var btnPause = document.getElementById("btnPause");
	var isPaused = false;
	btnPause.onclick = function() {
			isPaused = !isPaused;
			if(isPaused){
					for (i = notePlayTimeout.length - 1; i >= 0; i--){
							notePlayTimeout[i].pause();
					}
					btnPause.innerHTML = "Resume";
			}else{
					for (i = notePlayTimeout.length - 1; i >= 0; i--){
							notePlayTimeout[i].resume();
					}
					btnPause.innerHTML = "Pause";
			}
	}

	var btnFire = document.getElementById("btnFire");
	btnFire.onclick = function() {
			btnFire.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnFire.classList.remove("active");
			}, 150);

			fireMode++;
			if(fireMode > noOfFireMode){
					fireMode = 0;
			}
			setFireMode(fireMode);
	}

	var btnSpark = document.getElementById("btnSpark");
	btnSpark.onclick = function() {
			btnSpark.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnSpark.classList.remove("active");
			}, 150);
			numberOfSpark += increaseSpark;
			setSparkMode(numberOfSpark);
	}

	var currentPressDuration = 100;
	var addPressDuration = 100;
	var minPressDuration = 50;
	var maxPressDuration = 450;
	var btnPressDuration = document.getElementById("btnPressDuration");
	btnPressDuration.onclick = function() {
			btnPressDuration.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnPressDuration.classList.remove("active");
			}, 150);

			currentPressDuration += addPressDuration;
			if(currentPressDuration > maxPressDuration){
					currentPressDuration = minPressDuration;
			}
			btnPressDuration.innerHTML = "Duration per time : " + currentPressDuration + " ms";
	}

	var btnChangePerson = document.getElementById("btnChangePerson");
	var btnSwitchPersonHand = document.getElementById("btnSwitchPersonHand");
	var noOfPerson = 1;
	var maxPlayer = 2;
	btnChangePerson.onclick = function() {
			noOfPerson++;
			if(noOfPerson > maxPlayer){
					noOfPerson = 1;
			}
			btnChangePerson.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnChangePerson.classList.remove("active");
			}, 150);
			if(noOfPerson > 1){
					btnSwitchPersonHand.classList.remove("disabled");
					btnSwitchPersonHand.classList.add("abled");
					btnSwitchPersonHand.disabled = false;
			}else{
					btnSwitchPersonHand.classList.remove("abled");
					btnSwitchPersonHand.classList.add("disabled");
					btnSwitchPersonHand.disabled = true;
			}
			displayPiano();
			btnChangePerson.innerHTML = "No. of Players : " + noOfPerson;
	}

	var switchValue = 1;
	var centerX = [0, 0];
	var rightLegX = [0, 0];
	var leftLegX = [0, 0];
	var firstTime = [true, true];
	var noteCount = [0, 0];
	var leftHandOctave = [4, 4];
	var rightHandOctave = [4, 4];
	var avgSumOctaveByPerson = [11, 8];		//[RED - RIGHT, BLUE - LEFT]
	var speed = 1;

	btnSwitchPersonHand.onclick = function() {
			switchValue++;
			switchValue = switchValue % 2;
			var temp = avgSumOctaveByPerson[0];
			avgSumOctaveByPerson[0] = avgSumOctaveByPerson[1];
			avgSumOctaveByPerson[1] = temp;
			displayPiano();
			btnSwitchPersonHand.classList.add("active");
			btnClickTimeout[btnClickTimeout.length] = setTimeout(function() {
					btnSwitchPersonHand.classList.remove("active");
			}, 150);
	}
	//btn click end

	function editDownload(){
			let link = document.getElementById('downloadLink');
			link.download = currentPlaySongName.replace(new RegExp(" ", 'g'), "_") + '.txt';
			link.innerHTML = "Download : " + currentPlaySongName.replace(new RegExp(" ", 'g'), "_") + '.txt';
			let blob = new Blob([document.getElementById('fileContent').textContent + ""], {type: 'text/plain'});
			link.href = URL.createObjectURL(blob);
			link.style.display = "block";
			btnPlay.disabled = false;
			btnPlay.classList.remove("disabled");
			btnPlay.classList.add("abled");
			btnPlay.innerHTML = "Play : " + currentPlaySongName;
			btnStop.disabled = false;
			btnStop.classList.remove("disabled");
			btnStop.classList.add("abled");
			btnPause.disabled = false;
			btnPause.classList.remove("disabled");
			btnPause.classList.add("abled");
	}

	function detectChrome(){
			var ua = navigator.userAgent.toLowerCase();
			if (ua.indexOf('safari') != -1) {
			  if (ua.indexOf('chrome') > -1) {
			    	return true;
			  } else {
				    return false;
			  }
			}
	}

	function init(){
		if(!detectChrome()){
				alert("We're sorry. This page supports Google Chrome Browser only.");
				location.replace("/");
		}else{
				btnPlay.classList.add("disabled");
				btnStop.classList.add("disabled");
				btnPause.classList.add("disabled");
				btnSwitchPersonHand.classList.add("disabled");
				displayPiano();
				loadPianoList();
		}
	}

	var noOfFireMode = 2;
	var fireMode = 0;
	var fireTopCss = 500;
	var fireLeftCss = 500;
	var pianoPieceWidth = 0;

	var handIncreasePath = 80;
	var handFireVolume = 0;
	var maxHandFireVolume = 0;
	var minHandFireVolume = 0;
	var isReverseHand = false;
	var handMaxCount = 0;

	var legFireVolume = 0;
	var maxLegFireVolume = 0;
	var minLegFireVolume = 0;
	var legMaxCount = 0;

	var headFireVolume = 0;
	var maxHeadFireVolume = 0;
	var minHeadFireVolume = 0;
	var headMaxCount = 0;

	function restrictHandFireVolumeReverse(){
			if(handFireVolume < minHandFireVolume){
					handFireVolume = minHandFireVolume;
					isReverseHand = false;
			}else if(handFireVolume > maxHandFireVolume){
					handFireVolume = maxHandFireVolume;
					isReverseHand = true;
			}
	}

	function restrictHandFireVolume(){
			if(handFireVolume < minHandFireVolume){
					handFireVolume = minHandFireVolume;
			}else if(handFireVolume > maxHandFireVolume){
					handFireVolume = maxHandFireVolume;
					if(handMaxCount == 0){
							handMaxCount++;
					}
			}
	}

	function restrictLegFireVolume(){
			if(legFireVolume < minLegFireVolume){
					legFireVolume = minLegFireVolume;
			}else if(legFireVolume > maxLegFireVolume){
					legFireVolume = maxLegFireVolume;
					if(legMaxCount == 0){
							legMaxCount++;
					}
			}
	}

	function restrictHeadFireVolume(){
			if(headFireVolume < minHeadFireVolume){
					headFireVolume = minHeadFireVolume;
			}else if(headFireVolume > maxHeadFireVolume){
					headFireVolume = maxHeadFireVolume;
					if(headMaxCount == 0){
							headMaxCount++;
					}
			}
	}

	var isPiano3D = false;
	var pieces = 57;
	window.addEventListener("resize", displayPiano);
	function displayPiano(){
			centerX = [0, 0];
			rightLegX = [0, 0];
			leftLegX = [0, 0];
			firstTime = [true, true];
			var displayPiano = document.getElementById("displayPiano");
			displayPiano.innerHTML = "";
			//var width = window.innerWidth * 0.8;
			var width = Math.round((displayPiano.clientWidth + Number.EPSILON) * 1000) / 1000;
			fireTopCss = width;
			fireLeftCss = width;
			var height = Math.round((width * 5 / pieces + Number.EPSILON) * 1000) / 1000;
			var svg = "";
			var start_x = height;
			var end_x = height;
			var start_y = height * 2.5;
			var lineWidth = 1;
			var pianoWholeWidth = width - start_x - end_x;

			pianoPieceWidth = Math.round((pianoWholeWidth / pieces + Number.EPSILON) * 1000) / 1000;
			var pianoPieceHeight = Math.round((pianoPieceWidth * 3.5 + Number.EPSILON) * 1000) / 1000;

			// 3D
			var start3D_x = pianoPieceHeight;
			var piano3DPieceWidthUp = Math.round(((pianoWholeWidth - start3D_x * 2) / pieces + Number.EPSILON) * 1000) / 1000;

			maxHandFireVolume = 2.4 * pianoPieceWidth;
			minHandFireVolume = pianoPieceWidth / 2;
			if(fireMode == 1){
					restrictHandFireVolumeReverse();
			}else if(fireMode == 2){
					restrictHandFireVolume();
			}
			maxLegFireVolume = 7 * pianoPieceWidth;
			minLegFireVolume = 0;
			restrictLegFireVolume();

			maxHeadFireVolume = height * 2.1;
			minHeadFireVolume = 0;
			restrictHeadFireVolume();

			var keyNote = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

			svg += '<svg id="keyboard" height="'+(height+start_y*1.6)+'px" width="'+width+'px">';

			// 3D piano framework start
			var piano3DPieceHeight = pianoPieceWidth * 3 / 4;
			if(isPiano3D){
							//piano background model start
							svg += '<polygon points="'; //back
							svg += Math.round((start_x + start3D_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;		//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;		//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_1" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//left
							svg += Math.round((start_x - piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//left
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;		//y1
							svg += " ";
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;		//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_5" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//right
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//right
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_5" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//straight
							svg += Math.round((start_x + start3D_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;		//y2
							svg += " ";
							svg += Math.round((start_x + start3D_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;		//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//straight toppest
							svg += Math.round((start_x + start3D_x + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 5 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - piano3DPieceHeight * 2 - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 5 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + start3D_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight * 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_1" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//straight
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;		//y2
							svg += " ";
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;		//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							//piano background model end

							svg += '<polygon points="';
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + piano3DPieceHeight + pianoWholeWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_1" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + start3D_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - start3D_x + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_3" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x - piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + piano3DPieceHeight + pianoWholeWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + piano3DPieceHeight * 2 + pianoWholeWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_1" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2+ Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + piano3DPieceHeight * 2+ Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x - piano3DPieceHeight * 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							// piano background model leg start

							// 2 main legs start
							svg += '<polygon points="';
							svg += Math.round((start_x + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoPieceHeight / 2 + pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += '" class="pianoFramework pianoFramework_5" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceHeight / 2 - pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_5" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							// 2 main legs end

							// middle legs start
							svg += '<polygon points="';	//back
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth * 3 / 2 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth * 3 / 2 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_5" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//left leg
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//right leg
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight + piano3DPieceHeight * 3 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight - pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_2" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							// middle legs end

							// 3 Piano pedals start
							svg += '<polygon points="';
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight / 2 + pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceHeight / 2 - pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_4" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight / 2 - pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight / 2 + pianoPieceWidth + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceHeight / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_4" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							svg += '<polygon points="';	//middle
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceWidth / 4 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + Number.EPSILON) * 1000) / 1000;	//y1
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 + pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x2
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += " ";
							svg += Math.round((start_x + pianoWholeWidth / 2 - pianoPieceWidth / 2 + Number.EPSILON) * 1000) / 1000;	//x1
							svg += ",";
							svg += Math.round((start_y + pianoPieceHeight / 2 + piano3DPieceHeight * 3 + pianoWholeWidth / 8 + pianoPieceWidth * 1.5 + Number.EPSILON) * 1000) / 1000;	//y2
							svg += '" class="pianoFramework pianoFramework_4" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							// 3 Piano pedals end

							// piano background model leg end
			}
			// 3D piano framework end

			for(i = 0; i < pieces; i++){
					var looptime = 0;
					var start_i = i;
					var end_i = pieces - 1 - i;
					while(looptime < 2 && start_i <= end_i){
							if(start_i == end_i){
									looptime = 2;
							}else if(start_i > end_i){
									break;
							}

							if(looptime == 1){
									i = end_i;
							}

							svg += '<polygon id="key_'+keyNote[i%7]+'_'+Math.floor(i/7+1)+'" onClick="pressKey(this.id)" points="';
							if(!isPiano3D){
									svg += Math.round((start_x + pianoPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
							}else{
										// 3D
										svg += Math.round((start_x + start3D_x + piano3DPieceWidthUp * i + Number.EPSILON) * 1000) / 1000;	//x1
										svg += ",";
										svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y1
										svg += " ";
										svg += Math.round((start_x + start3D_x + piano3DPieceWidthUp * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
										svg += ",";
										svg += Math.round((start_y  + Number.EPSILON) * 1000) / 1000;	//y1
										svg += " ";
										svg += Math.round((start_x + pianoPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
										svg += ",";
										svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
										svg += " ";
										svg += Math.round((start_x + pianoPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
										svg += ",";
										svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
							}
							svg += '" class="whiteKey" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							// 3D
							if(isPiano3D){
											svg += '<polygon id="key_3d_'+keyNote[i%7]+'_'+Math.floor(i/7+1)+'" points="';
											svg += Math.round((start_x + pianoPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
											svg += ",";
											svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
											svg += ",";
											svg += Math.round((start_y + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y2
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
											svg += ",";
											svg += Math.round((start_y + pianoPieceWidth * 3 / 4 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y3
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
											svg += ",";
											svg += Math.round((start_y + pianoPieceWidth * 3 / 4 + pianoPieceHeight + Number.EPSILON) * 1000) / 1000;	//y3
											svg += '" class="whiteKey whiteKey3D" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							}
							looptime++;
					}
					i = start_i;
			}

			var blackNum = [1, 2, 4, 5, 6];
			var blackKeyNote = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
			for(i = 0; i < pieces; i++){
					if(i == pieces - 1){
						break;
					}
					if(blackNum.includes(i % 7 + 1)){
							// 3D
							var blackToWhiteRatio = 2 / 3;
							var bufferDiff = (start3D_x + piano3DPieceWidthUp * (i + 1 / 2) - pianoPieceWidth * (i + 1 / 2)) * (1 - blackToWhiteRatio); // x1 diff

							svg += '<polygon id="key_'+blackKeyNote[i%7]+'_'+Math.floor(i/7+1)+'" onClick="pressKey(this.id)" points="';
							if(!isPiano3D){
									svg += Math.round((start_x + pianoPieceWidth * (i + 0.75) + Number.EPSILON) * 1000) / 1000;	//x1
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * (i % 2) * 2 / 3 + Number.EPSILON) * 1000) / 1000;	//y1
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * (i + 0.75 + 0.5) + Number.EPSILON) * 1000) / 1000;	//x2
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * (i % 2) * 2 / 3 + Number.EPSILON) * 1000) / 1000;	//y1
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * (i + 0.75 + 0.5) + Number.EPSILON) * 1000) / 1000;	//x2
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * ((i + 1) % 2) * 2 / 3 + Number.EPSILON) * 1000) / 1000;	//y2
									svg += " ";
									svg += Math.round((start_x + pianoPieceWidth * (i + 0.75) + Number.EPSILON) * 1000) / 1000;	//x1
									svg += ",";
									svg += Math.round((start_y + pianoPieceHeight * ((i + 1) % 2) * 2 / 3 + Number.EPSILON) * 1000) / 1000;	//y2
							}else{
										// 3D
										svg += Math.round((start_x + start3D_x + piano3DPieceWidthUp * (i + 0.75) + Number.EPSILON) * 1000) / 1000;	//x1
										svg += ",";
										svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y1
										svg += " ";
										svg += Math.round((start_x + start3D_x + piano3DPieceWidthUp * (i + 0.75 + 0.5) + Number.EPSILON) * 1000) / 1000;	//x2
										svg += ",";
										svg += Math.round((start_y + Number.EPSILON) * 1000) / 1000;	//y1
										svg += " ";
										svg += Math.round((start_x + pianoPieceWidth * (i + 0.75 + 0.5) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x2
										svg += ",";
										svg += Math.round((start_y + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y2
										svg += " ";
										svg += Math.round((start_x + pianoPieceWidth * (i + 0.75) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x1
										svg += ",";
										svg += Math.round((start_y + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y2
							}
							svg += '" class="blackKey" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

							// 3D
							if(isPiano3D){
											svg += '<polygon id="key_3d_'+blackKeyNote[i%7]+'_'+Math.floor(i/7+1)+'" points="';
											svg += Math.round((start_x + pianoPieceWidth * (i + 0.75) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x1
											svg += ",";
											svg += Math.round((start_y + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y2
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * (i + 0.75 + 0.5) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x2
											svg += ",";
											svg += Math.round((start_y + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y2
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * (i + 0.75 + 0.5) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x2
											svg += ",";
											svg += Math.round((start_y + pianoPieceWidth / 4 + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y3
											svg += " ";
											svg += Math.round((start_x + pianoPieceWidth * (i + 0.75) + bufferDiff + Number.EPSILON) * 1000) / 1000;	//x1
											svg += ",";
											svg += Math.round((start_y + pianoPieceWidth / 4 + pianoPieceHeight * blackToWhiteRatio + Number.EPSILON) * 1000) / 1000;	//y3
											svg += '" class="blackKey blackKey3D" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
							}
					}
			}

			// person edit start
			var personColor = "black";
			var headColor = "white";
			for(i = 1; i <= noOfPerson; i++){
						if(noOfPerson >= 2){
								if(i % 2 == 1){
										personColor = "#ff3e3e";
								}else{
										personColor = "#00b1ff";
								}
						}
						svg += '<circle cx="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" cy="'
													+ Math.round(start_y - height * 5 / 6 + Number.EPSILON) * 1000 / 1000
													+ '" r="'+(height/2)+'" stroke="'+personColor+'" stroke-width="2" fill="'+headColor+'" class="head person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 1 / 3 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 6 / 7 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y - height * 1 / 3 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="leftHand person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 3 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 6 / 7 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y - height * 1 / 3 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="rightHand person"/>';

						//fire start
						svg += '<foreignobject class="fireNode fireObjectRightHand" x="'
										+ Math.round(start_x + pianoWholeWidth * 2 / 3 - fireLeftCss + Number.EPSILON) * 1000 / 1000
										+ '" y="'
										+ Math.round(start_y + height * 6 / 7 - fireTopCss + Number.EPSILON) * 1000 / 1000
										+ '" width="'
										+ (fireLeftCss * 2)
										+ '" height="'
										+ (fireTopCss * 2)
										+ '"><div class="fire fireHand" style="top:'
										+	(fireTopCss - handFireVolume / 3)
										+ 'px; left:'
										+ fireLeftCss
										+ 'px; height:'
										+ handFireVolume
										+ 'px; width:'
										+ handFireVolume
										+ 'px;"><div class="flames"><div class="flame"></div>'
										+ '<div class="flame"></div><div class="flame"></div><div class="flame"></div></div></div>'
										+ '</foreignobject>';

						svg += '<foreignobject class="fireNode fireObjectLeftHand" x="'
										+ Math.round(start_x + pianoWholeWidth * 1 / 3 - fireLeftCss + Number.EPSILON) * 1000 / 1000
										+ '" y="'
										+ Math.round(start_y + height * 6 / 7 - fireTopCss + Number.EPSILON) * 1000 / 1000
										+ '" width="'
										+ (fireLeftCss * 2)
										+ '" height="'
										+ (fireTopCss * 2)
										+ '"><div class="fire fireHand" style="top:'
										+	(fireTopCss - handFireVolume / 3)
										+ 'px; left:'
										+ fireLeftCss
										+ 'px; height:'
										+ handFireVolume
										+ 'px; width:'
										+ handFireVolume
										+ 'px;"><div class="flames"><div class="flame"></div>'
										+ '<div class="flame"></div><div class="flame"></div><div class="flame"></div></div></div>'
										+ '</foreignobject>';

						svg += '<foreignobject class="fireNode fireObjectRightLeg fireBody" x="'
										+ Math.round(start_x + pianoWholeWidth * 7.5 / 13 - fireLeftCss + Number.EPSILON) * 1000 / 1000
										+ '" y="'
										+ Math.round(start_y + height * 5 / 2 - fireTopCss + Number.EPSILON) * 1000 / 1000
										+ '" width="'
										+ (fireLeftCss * 2)
										+ '" height="'
										+ fireTopCss
										+ '"><div class="fire fireLeg" style="top:'
										+	(fireTopCss - handFireVolume / 3)
										+ 'px; left:'
										+ fireLeftCss
										+ 'px; height:'
										+ legFireVolume
										+ 'px; width:'
										+ legFireVolume
										+ 'px;"><div class="flames"><div class="flame"></div>'
										+ '<div class="flame"></div><div class="flame"></div><div class="flame"></div></div></div>'
										+ '</foreignobject>';

						svg += '<foreignobject class="fireNode fireObjectLeftLeg fireBody" x="'
										+ Math.round(start_x + pianoWholeWidth * 5.5 / 13 - fireLeftCss + Number.EPSILON) * 1000 / 1000
										+ '" y="'
										+ Math.round(start_y + height * 5 / 2 - fireTopCss + Number.EPSILON) * 1000 / 1000
										+ '" width="'
										+ (fireLeftCss * 2)
										+ '" height="'
										+ fireTopCss
										+ '"><div class="fire fireLeg" style="top:'
										+	(fireTopCss - handFireVolume / 3)
										+ 'px; left:'
										+ fireLeftCss
										+ 'px; height:'
										+ legFireVolume
										+ 'px; width:'
										+ legFireVolume
										+ 'px;"><div class="flames"><div class="flame"></div>'
										+ '<div class="flame"></div><div class="flame"></div><div class="flame"></div></div></div>'
										+ '</foreignobject>';

						svg += '<foreignobject class="fireNode fireObjectHead fireBody" x="'
										+ Math.round(start_x + pianoWholeWidth * 2 / 4 - fireLeftCss + Number.EPSILON) * 1000 / 1000
										+ '" y="'
										+ Math.round(start_y - height * 5 / 6 - fireTopCss + Number.EPSILON) * 1000 / 1000
										+ '" width="'
										+ (fireLeftCss * 2)
										+ '" height="'
										+ (fireTopCss * 2)
										+ '"><div class="fire fireHead" style="top:'
										+	fireTopCss
										+ 'px; left:'
										+ fireLeftCss
										+ 'px; height:'
										+ headFireVolume
										+ 'px; width:'
										+ headFireVolume
										+ 'px;"><div class="flames"><div class="flame"></div>'
										+ '<div class="flame"></div><div class="flame"></div><div class="flame"></div></div></div>'
										+ '</foreignobject>';
						//fire end

						//spark start
						for(j = 0; j < maxSpark; j++){
							svg += '<foreignobject class="sparkNode" x="'
											+ Math.round(start_x + pianoWholeWidth * 1 / 3 - fireLeftCss + Number.EPSILON) * 1000 / 1000
											+ '" y="'
											+ Math.round(start_y + height * 6 / 7 - fireTopCss + Number.EPSILON) * 1000 / 1000
											+ '" width="'
											+ (fireLeftCss * 2)
											+ '" height="'
											+ (fireTopCss * 2)
											+ '"><div class="spark" style="top:'
											+	fireTopCss
											+ 'px; left:'
											+ fireLeftCss
											+ 'px; height:'
											+ pianoPieceWidth / 4
											+ 'px; width:'
											+ pianoPieceWidth / 4
											+ 'px;"></div>'
											+ '</foreignobject>';
						}
						//spark end

						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 2 / 1 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y - height * 1 / 3 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="personBodyCenter person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 2 / 1 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 7.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y + height * 3 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="personBodyRight person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 2 / 4 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 2 / 1 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 5.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y + height * 3 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="personBodyLeft person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 5.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 3 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 5.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y + height * 5 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="leftLeg person"/>';
						svg += '<line x1="'
													+ Math.round(start_x + pianoWholeWidth * 7.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y1="'
													+ Math.round(start_y + height * 3 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" x2="'
													+ Math.round(start_x + pianoWholeWidth * 7.5 / 13 + Number.EPSILON) * 1000 / 1000
													+ '" y2="'
													+ Math.round(start_y + height * 5 / 2 + Number.EPSILON) * 1000 / 1000
													+ '" style="stroke:'+personColor+';stroke-width:2;" class="rightLeg person"/>';
			}
			// person edit end

			svg += '</svg>';
			displayPiano.innerHTML = svg;
			resetPersonPosition(noOfPerson, pianoWholeWidth);
			setFireMode(fireMode);
			setSparkMode(numberOfSpark);

			var elmnt = document.getElementById("btnPlay");
			elmnt.scrollIntoView();
	}

	//spark start brendan
	var sparkArr = document.getElementsByClassName("spark");
	var lastSpark = 0;
	var maxSpark = 1000;
	var baseCssNum = 1;

	var numberOfSpark = maxSpark;
	var minNoOfSpark = 3;
	var increaseSpark = 3;
	var maxNoOfSpark = 9;

	function changeSparkAni(x, y){
			if(lastSpark + numberOfSpark >= maxSpark){
					lastSpark = 0;
			}

			for(i = baseCssNum + lastSpark + maxSpark; i < numberOfSpark + baseCssNum + lastSpark + maxSpark; i++){
					var randomX = Math.floor(Math.random() * Math.floor(pianoPieceWidth*7));
					var randomY = Math.floor(Math.random() * Math.floor(pianoPieceWidth*7)) * (-1);
					if(Math.floor(Math.random() * Math.floor(2)) == 1){
							randomX *= (-1);
					}
					randomX += x;
					randomY += y;

					min = Math.ceil(16515072);
					max = Math.floor(15662848);
					randomColor = (Math.floor(Math.random() * (max - min)) + min).toString(16);

					document.styleSheets[6].cssRules[i].cssRules[0].style.cssText = "opacity: 1; background-color: #"
																																				+ randomColor
																																				+ "; left:"
																																				+ x
																																				+ "px; top:"
																																				+ y
																																				+ "px;";
					document.styleSheets[6].cssRules[i].cssRules[1].style.cssText = "opacity: 0; left:"
																																				+ randomX
																																				+ "px; top:"
																																				+ randomY
																																				+ "px;";
			}
			startSpark(lastSpark);
			lastSpark += numberOfSpark;
	}

	var divide = 6; //must be larger than 2
	function startSpark(num){
			if(divide < 3){
					divide = 3;
			}
			var period = parseInt(maxSpark / numberOfSpark / divide) * numberOfSpark;
			for(i = num; i < num + numberOfSpark; i++){
					document.getElementsByClassName("spark")[i].classList.add("spark_" + i);
			}
			if(num % period == 0){
					endSpark(num, period);
			}
	}


	function endSpark(num, period){
				if(num == 0){
						for(i = maxSpark - period - 1; i >= maxSpark - period * 2; i--){
								document.getElementsByClassName("spark")[i].classList.remove("spark_" + i);
						}
				}else if(num == period){
						for(i = maxSpark - 1; i >= maxSpark - period; i--){
								document.getElementsByClassName("spark")[i].classList.remove("spark_" + i);
						}
				}else{
						for(i = num - period * 2; i < num - period; i++){
								document.getElementsByClassName("spark")[i].classList.remove("spark_" + i);
						}
				}
	}

	function printSparkCss(){
			var result = "";
			for(i = 0; i < maxSpark; i++){
					result += ".spark_"+i+"{animation-duration: 1s; animation-name: process_"+i+"}\n";
			}
			for(i = 0; i < maxSpark; i++){
					result += "@keyframes process_"
									+ i
									+ " { 0% { opacity: 1; background-color: red; left: 0px; top: 0px; }  100% { opacity: 0; left: 0px; top: 0px; }}\n";
			}
			console.log(result);
	}
	//spark end

	function setFireMode(mode){
			var fireNode = document.getElementsByClassName("fireNode");
			if(mode == 0){
					for(i = 0; i < fireNode.length; i++){
							fireNode[i].style.display = "none";
					}
					btnFire.innerHTML = "Fire : Off";
			}else{
					for(i = 0; i < fireNode.length; i++){
							fireNode[i].style.display = "block";
					}
					var fireBody = document.getElementsByClassName("fireBody");
					if(mode == 1){
							btnFire.innerHTML = "Fire : Hand";
							for(i = 0; i < fireBody.length; i++){
									fireBody[i].style.display = "none";
							}
					}else if(mode == 2){
							btnFire.innerHTML = "Fire : All";
					}
			}
	}

	var sparkNode = document.getElementsByClassName("sparkNode");
	function setSparkMode(num){
			if(num > maxNoOfSpark || num < minNoOfSpark){
					for(i = 0; i < sparkNode.length; i++){
							sparkNode[i].style.display = "none";
					}
					btnSpark.innerHTML = "Spark : Off";
					numberOfSpark = minNoOfSpark - increaseSpark;
			}else{
					for(i = 0; i < sparkNode.length; i++){
							sparkNode[i].style.display = "block";
					}
					btnSpark.innerHTML = "Spark No. : " + numberOfSpark;
			}
	}

	function pressKey(id){
			var idArr = id.split('_');
			playOneNote(idArr[1], idArr[2], 2, 0, 1);
	}

	document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
	function handleFileSelect(event){
	  const reader = new FileReader()
	  reader.onload = handleFileLoad;
		if(event.target.files.length > 0){
		  reader.readAsText(event.target.files[0]);
		}
	}

	function handleFileLoad(event){
			currentPlaySongName = "Your Uploaded file";
			if(event.target.result.includes("//sample rate (4000-44100) _ volume _ speed")){
					loadText(event.target.result);
			}else if(event.target.result.includes("MFile")){
					loadDecodeText(event.target.result);
					loadText(document.getElementById('fileContent').textContent);
			}
			reset();
	}

	function reset(){
			document.getElementById("fileInput").remove();
			document.getElementById("fileUploadDiv").innerHTML = '<input id="fileInput" type="file" name="file" />';
			document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
	}

	function encryptFileName(name){
			return name.replace(new RegExp("'", 'g'), 'P@ssw0rd123');
	}
	function decryptFileName(name){
			return name.replace(new RegExp('P@ssw0rd123', 'g'), "'");
	}
	function loadSrc(type){
				type = decryptFileName(type);
				myFunction();
				currentPlaySongName = type;
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function(){
					if(xmlhttp.status == 200 && xmlhttp.readyState == 4){
							var string = [];
							var txt = xmlhttp.responseText;
							loadText(txt.trim());
					}
				};
				xmlhttp.open("GET","./music/txt/" + type + ".txt",true);
				xmlhttp.send();
	}

	var valueModifySpeed = 30;
	function loadText(text){
			displayPiano();
			clearAllTimeout();
			noteCount = [0, 0];
			lastSpark = 0;
		  document.getElementById('fileContent').textContent = text;
			editDownload();
			var seperate = '//sample rate (4000-44100) _ volume _ speed';
			if(text.includes(seperate)){
					var headerFooterArr = text.split(seperate);
					if(headerFooterArr.length == 2){
							var headerArr = headerFooterArr[0].trim().split("_");
							if(headerArr.length == 3){
									Synth.setSampleRate(headerArr[0].trim());
									Synth.setVolume(headerArr[1].trim());
									speed = headerArr[2].trim() / valueModifySpeed;
							}
							text = headerFooterArr[1].trim();
					}
			}

			var noteArr = text.split('\n');
			var startTime = 1000;
			var addTime = 0;
			var personIndex = 1;

			//count time diff start - get timeDiff from play to another person start
			var timeDiff = 0;
		 	var start = new Date().getTime();
			//count time diff end - get timeDiff from play to another person end

			//check more than one person start
			if(!checkMoreThanOnePerson(noteArr)){
					if(noOfPerson > 1){
							document.getElementById("btnChangePerson").click();
					}
					btnChangePerson.classList.remove("abled");
					btnChangePerson.classList.add("disabled");
					btnChangePerson.disabled = true;
			}else{
						btnChangePerson.classList.remove("disabled");
						btnChangePerson.classList.add("abled");
						btnChangePerson.disabled = false;
			}
			//check more than one person end

			for(i = 0; i < noteArr.length; i++){
					var tempArr = noteArr[i].split('_');
					if(tempArr.length == 4){

							// use durtion start
							tempArr[2] = tempArr[2] / speed;
							// use durtion end
							startTime += addTime;
							addTime = tempArr[3] / speed;

							if(tempArr[3] < -5000 && noOfPerson > 1){		//another person - (-5) will be modified to dynamic later - brendan
									personIndex++;
									if(personIndex > 2){
											personIndex = 1;
									}
									// get timeDiff from play to another person start
							 		end = new Date().getTime();
									timeDiff = end - start;
									//console.log(timeDiff);
									// get timeDiff from play to another person end
							}

							playOneNote(tempArr[0].trim(), tempArr[1], tempArr[2], startTime - timeDiff, personIndex);
					}
			}
	}

	function checkMoreThanOnePerson(noteArr){
					for(i = 0; i < noteArr.length; i++){
							var tempArr = noteArr[i].split('_');
							if(tempArr.length == 4){
									if(tempArr[3] < -5000){		//another person - (-5) will be modified to dynamic later - brendan
											return true;
									}
							}
					}
					return false;
	}

	var leftHand = document.getElementsByClassName("leftHand");
	var rightHand = document.getElementsByClassName("rightHand");
	var personBodyCenter = document.getElementsByClassName("personBodyCenter");
	var head = document.getElementsByClassName("head");
	var personBodyRight = document.getElementsByClassName("personBodyRight");
	var personBodyLeft = document.getElementsByClassName("personBodyLeft");
	var rightLeg = document.getElementsByClassName("rightLeg");
	var leftLeg = document.getElementsByClassName("leftLeg");
	var fireRightHand = document.getElementsByClassName("fireObjectRightHand");
	var fireLeftHand = document.getElementsByClassName("fireObjectLeftHand");
	var fireRightLeg = document.getElementsByClassName("fireObjectRightLeg");
	var fireLeftLeg = document.getElementsByClassName("fireObjectLeftLeg");
	var fireHead = document.getElementsByClassName("fireObjectHead");

	function resetPersonPosition(numPeople, pianoWholeWidth){
				var width = pianoWholeWidth;

				if(numPeople > 1){
						for(i = 0; i < numPeople; i++){
								var negOne = -1;
								if(i % 2 == switchValue){
										negOne = 1;
								}
								personBodyCenter[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								personBodyCenter[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								personBodyRight[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								personBodyRight[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								personBodyLeft[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								personBodyLeft[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								leftHand[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								leftHand[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								rightHand[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								rightHand[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								head[i].cx.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								rightLeg[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								rightLeg[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								leftLeg[i].x1.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								leftLeg[i].x2.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;

								fireRightHand[i].x.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								fireLeftHand[i].x.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								fireRightLeg[i].x.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								fireLeftLeg[i].x.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
								fireHead[i].x.baseVal.value -= width * negOne * (parseInt(i / 2) + 1) / 12.5;
						}
				}
	}

	function moveHand(note, octave, left, personIndex){
				if(legMaxCount > 0 && fireMode == 2 && headFireVolume <= maxHeadFireVolume){
						headFireVolume += (maxHeadFireVolume - minHeadFireVolume) / (handIncreasePath / 3);
				}
				if(handMaxCount > 0 && fireMode == 2 && legFireVolume <= maxLegFireVolume){
						legFireVolume += (maxLegFireVolume - minLegFireVolume) / handIncreasePath;
				}
				if(isReverseHand && fireMode == 1){
						handFireVolume -= (maxHandFireVolume - minHandFireVolume) / handIncreasePath;
				}else{
						if(handFireVolume <= maxHandFireVolume){
								handFireVolume += (maxHandFireVolume - minHandFireVolume) / handIncreasePath;
						}
				}
				if(left){
						leftHandOctave[personIndex - 1] = parseInt(octave);
				}else{
						rightHandOctave[personIndex - 1] = parseInt(octave);
				}

				var totalOctave = parseInt(leftHandOctave[personIndex - 1]) + parseInt(rightHandOctave[personIndex - 1]);
				var polygon = document.getElementById("key_"+note+"_"+octave);

				if(polygon == null){
						console.log("key_"+note+"_"+octave);
						return;
				}

				var xValue = 0;
				var yValue = 0;
				var yValueSharp = 0;
				var yValueNormal = 0;
				var yHigh = 0;
				var yLow = 99999999;
				for(i = 0; i < polygon.points.length; i++){
								if(isPiano3D && (i == 0 || i == 1)){
										xValue += polygon.points[i+2].x;
										yValue += polygon.points[i+2].y;
								}else{
										xValue += polygon.points[i].x;
										yValue += polygon.points[i].y;
								}
								if(polygon.points[i].y > yHigh){
										yHigh = polygon.points[i].y;
								}
								if(polygon.points[i].y < yLow){
										yLow = polygon.points[i].y;
								}
				}
				xValue = xValue / polygon.points.length;
				if(isPiano3D){	// 3D
						yValueSharp = yLow + (yHigh - yLow) * 7 / 8;
				}else{
						yValueSharp = yLow + (yHigh - yLow) / 3;
				}
				yValueNormal = yHigh - (yHigh - yLow) / 5;
				if(note.includes('#')){
						yValue = yValueSharp;
				}else{
						yValue = yValueNormal;
				}

				if(fireMode == 1){
						restrictHandFireVolumeReverse();
				}else if(fireMode == 2){
						restrictHandFireVolume();
				}
				restrictLegFireVolume();
				restrictHeadFireVolume();
				if(left){
						leftHand[personIndex - 1].x1.baseVal.value = xValue;
						leftHand[personIndex - 1].y1.baseVal.value = yValue;
						fireLeftHand[personIndex - 1].x.baseVal.value = xValue - fireLeftCss;
						fireLeftHand[personIndex - 1].y.baseVal.value = yValue - fireTopCss - handFireVolume / 3;
				}else{
						rightHand[personIndex - 1].x1.baseVal.value = xValue;
						rightHand[personIndex - 1].y1.baseVal.value = yValue;
						fireRightHand[personIndex - 1].x.baseVal.value = xValue - fireLeftCss;
						fireRightHand[personIndex - 1].y.baseVal.value = yValue - fireTopCss - handFireVolume / 3;
				}

				//spark start
				if(lastSpark + numberOfSpark >= maxSpark){
						lastSpark = 0;
				}
				for(i = lastSpark; i < lastSpark + numberOfSpark; i++){
						sparkNode[i].x.baseVal.value = xValue - fireLeftCss;
						sparkNode[i].y.baseVal.value = yValue - fireTopCss - handFireVolume / 6;
				}
				changeSparkAni(fireLeftCss, fireTopCss);
				//spark end

				var fireHandArr = document.getElementsByClassName("fireHand");
				for(j = 0; j < fireHandArr.length; j++){
						fireHandArr[j].style.height = handFireVolume + "px";
						fireHandArr[j].style.width = handFireVolume + "px";
				}
				var fireLegArr = document.getElementsByClassName("fireLeg");
				for(j = 0; j < fireLegArr.length; j++){
						fireLegArr[j].style.height = legFireVolume + "px";
						fireLegArr[j].style.width = legFireVolume + "px";
				}
				var fireHeadArr = document.getElementsByClassName("fireHead");
				for(j = 0; j < fireHeadArr.length; j++){
						fireHeadArr[j].style.height = headFireVolume + "px";
						fireHeadArr[j].style.width = headFireVolume + "px";
				}

				if(firstTime[personIndex - 1]){
						centerX[personIndex - 1] = personBodyCenter[personIndex - 1].x1.baseVal.value;
						leftLegX[personIndex - 1] = leftLeg[personIndex - 1].x1.baseVal.value;
						rightLegX[personIndex - 1] = rightLeg[personIndex - 1].x1.baseVal.value;
						firstTime[personIndex - 1] = false;
				}

				var avgSum = 8
				if(noOfPerson >= 2){
						avgSum = avgSumOctaveByPerson[personIndex - 1];
				}

				var moveDistance = (yHigh - yLow) * (avgSum - totalOctave) / 3;
				personBodyCenter[personIndex - 1].x2.baseVal.value =	centerX[personIndex - 1] - moveDistance;
				leftHand[personIndex - 1].x2.baseVal.value =	centerX[personIndex - 1] - moveDistance;
				rightHand[personIndex - 1].x2.baseVal.value =	centerX[personIndex - 1] -	moveDistance;
				head[personIndex - 1].cx.baseVal.value =	centerX[personIndex - 1] -	moveDistance;

				fireHead[personIndex - 1].x.baseVal.value =	centerX[personIndex - 1] -	moveDistance - fireLeftCss;

				rightLeg[personIndex - 1].x1.baseVal.value = rightLegX[personIndex - 1] - moveDistance / 10;
				leftLeg[personIndex - 1].x1.baseVal.value = leftLegX[personIndex - 1] -	moveDistance / 10;
				personBodyRight[personIndex - 1].x2.baseVal.value = rightLegX[personIndex - 1] -	moveDistance / 10;
				personBodyRight[personIndex - 1].x1.baseVal.value = centerX[personIndex - 1] -	moveDistance / 10;
				personBodyLeft[personIndex - 1].x2.baseVal.value = leftLegX[personIndex - 1] -	moveDistance / 10;
				personBodyLeft[personIndex - 1].x1.baseVal.value = centerX[personIndex - 1] -	moveDistance / 10;
				personBodyCenter[personIndex - 1].x1.baseVal.value =	centerX[personIndex - 1] - moveDistance / 10;
	}

	var minNoteLast = 1.8;
	var maxNoteLast = 2.8;
	var buffer = 0.2;
	var piano = Synth.createInstrument('piano');
	function playOneNote(note, octave, duration, startTime, personIndex){
			notePlayTimeout[notePlayTimeout.length] = new Timer(function() {
						var finalDuration = duration / 1000;
						if(finalDuration < minNoteLast){
								finalDuration = minNoteLast;
						}else if(finalDuration > maxNoteLast){
								finalDuration = maxNoteLast;
						}

						piano.play(note, octave, finalDuration + buffer); // plays C4 for 2s using the 'piano' sound profile

						// 3D
						if(isPiano3D){
								press3DPiano(note, octave);
						}else{
								var noteSvg = document.getElementById("key_"+note+"_"+octave);
								noteSvg.classList.add("pressed");
								btnReleaseTimeout[btnReleaseTimeout.length] = setTimeout(function() {
										noteSvg.classList.remove("pressed");
								}, currentPressDuration);
						}

						//use hand start
						noteCount[personIndex - 1]++;
						if(noteCount[personIndex - 1] % 2 == 0){
								moveHand(note, octave, false, personIndex);
						}else{
								moveHand(note, octave, true, personIndex);
						}
						//use hand end

			}, startTime);
	}

	// 3D
	function press3DPiano(note, octave){
			var polygon3D = document.getElementById("key_3d_"+note+"_"+octave);
			var pushDiff = (polygon3D.points[3].y - polygon3D.points[0].y) * 2 / 3;
			polygon3D.points[0].y += pushDiff;
			polygon3D.points[1].y += pushDiff;

			var polygon = document.getElementById("key_"+note+"_"+octave);
			for(var i = 0; i < polygon.points.length; i++){
					polygon.points[i].y += pushDiff;
			}

			btnReleaseTimeout[btnReleaseTimeout.length] = setTimeout(function() {
					polygon3D.points[0].y -= pushDiff;
					polygon3D.points[1].y -= pushDiff;

					for(var i = 0; i < polygon.points.length; i++){
							polygon.points[i].y -= pushDiff;
					}
			}, currentPressDuration);
	}

	var pianoKeyArr = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
	function loadDecodeMidi(type){
					currentPlaySongName = type;
					myFunction();
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function(){
						if(xmlhttp.status == 200 && xmlhttp.readyState == 4){
								var string = [];
								var decodeMidiData = xmlhttp.responseText;
								loadDecodeText(decodeMidiData);
								loadText(document.getElementById('fileContent').textContent);
						}
					};
					xmlhttp.open("GET","./music/decodeMidi/"+type+".txt",true);
					xmlhttp.send();
	}

	function loadDecodeText(decodeMidiData){

				var decodeMidiDataArr = decodeMidiData.split('\n');

				var midiToTxt = "";
				var lastStartTime = 0;
				midiToTxt += "20000_0.3_30 //sample rate (4000-44100) _ volume _ speed\n";

				for(i = 0; i < decodeMidiDataArr.length; i++){
						if(!decodeMidiDataArr[i].includes(" On ") || decodeMidiDataArr[i].includes(" v=0")){
								continue;
						}

						var tempArr = decodeMidiDataArr[i].split(" On ");
						var startTime = lastStartTime;
						var addTime = 0;
						var noteAndOctave = "";
						if(tempArr.length > 1){
								noteAndOctave = tempArr[1].split(" n=")[1].split(" v=")[0];
								startTime = parseInt(tempArr[0]);
						}
						var note = "";
						var octave = "";
						var duration = 2;

						//find duration start
						var skipNote = false;
						for(j = i + 1; j < decodeMidiDataArr.length; j++){
								if(!decodeMidiDataArr[j].includes(" Off ") && !decodeMidiDataArr[j].includes(" v=0")){
										continue;
								}

								var offArr = [];
								if(decodeMidiDataArr[j].includes(" Off ")){
										offArr = decodeMidiDataArr[j].split(" Off ");
								}else{
										offArr = decodeMidiDataArr[j].split(" On ");
								}
								var offNoteAndOctave = "";
								if(offArr.length > 1){
										offNoteAndOctave = offArr[1].split(" n=")[1].split(" v=")[0];
										offStartTime = parseInt(offArr[0]);
								}
								if(noteAndOctave == offNoteAndOctave){
										duration = offStartTime - startTime;
										if(duration == 0){
												skipNote = true;
										}
										break;
								}
						}
						if(skipNote){
								continue;
						}
						//find duration end

						if(lastStartTime == 0){
								lastStartTime = startTime;
						}
						addTime = startTime - lastStartTime;

						lastStartTime = startTime;
						note = pianoKeyArr[noteAndOctave % 12];
						octave = parseInt(noteAndOctave / 12);
						midiToTxt += note + "_" + octave + "_" + duration + "_" + addTime + "\n";
				}

				document.getElementById('fileContent').innerHTML = midiToTxt.substring(0, midiToTxt.length - 1);
	}

	function clearAllTimeout(){

			for (i = btnClickTimeout.length - 1; i >= 0; i--){
					clearInterval(btnClickTimeout[i]);
			}
			for (i = btnReleaseTimeout.length - 1; i >= 0; i--){
					clearInterval(btnReleaseTimeout[i]);
			}
			for (i = notePlayTimeout.length - 1; i >= 0; i--){
					notePlayTimeout[i].clear();
			}

			var whiteKeyArr = document.getElementsByClassName("whiteKey");
			var blackKeyArr = document.getElementsByClassName("blackKey");
			for(i = 0; i < whiteKeyArr.length; i++){
					whiteKeyArr[i].classList.remove("pressed");
			}
			for(i = 0; i < blackKeyArr.length; i++){
					blackKeyArr[i].classList.remove("pressed");
			}

			for(i = 0; i < maxSpark; i++){
					document.getElementsByClassName("spark")[i].classList.remove("spark_" + i);
			}

			btnClickTimeout = [];
			btnReleaseTimeout = [];
			notePlayTimeout = [];
	}

	function Timer(callback, delay) {
	    var timerId, start, remaining = delay;

	    this.pause = function() {
	        window.clearTimeout(timerId);
	        remaining -= new Date() - start;
	    };

	    this.resume = function() {
	        start = new Date();
	        window.clearTimeout(timerId);
					if(remaining >= 0){
	        		timerId = window.setTimeout(callback, remaining);
					}
	    };

	    this.clear = function() {
	        window.clearTimeout(timerId);
	    };

	    this.resume();
	}
	</script>

	<ul id="foot">
		</br>
		<li>© Copyright 2020. All Rights Reserved.</li>
	</ul></br>
</body>
</html>
