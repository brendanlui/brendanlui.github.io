<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
	<link id="stylecall1" rel="stylesheet" href="/css/academic_style.css" />
	<link id="stylecall2" rel="stylesheet" href="/css/logo_dadiu.css" />
	<link id="stylecall3" rel="stylesheet" href="/css/inputButton.css" />
	<link id="stylecall3" rel="stylesheet" href="/css/piano.css" />
	<link rel="icon"
	  type="image/png"
	  href="/img/d01.png">
	  <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.scrollTo.js"></script>
		<script type="text/javascript" src="/js/audiosynth.js"></script>

</head>

<title>Dadiu | Piano</title>

<body onload="init()">
	<div id="head">
		<div id="logo">
			<a href="/"><img src="/img/dadiu.png" alt="dai01" class="logo_dadiu"></a>
		</div>
	</div>

	<link rel="stylesheet" href="/css/responsive_bar_style.css">
	<div class="topnav" id="myTopnav">
	  <a href="/">Home</a>
	</div>

	<!--TODO-->
	<div id="buttonBox">
	  	<button id="btnClick" class="buttonJp btnFilter" onclick="loadSrc('Default')">Default</button>
		  <button id="btnClick" class="buttonJp btnFilter" onclick="loadFile()">File</button>
	</div>
	<div id="fileUploadDiv">
  		<input id="fileInput" type="file" name="file" />
	</div>
	<a id="downloadLink">Download</a>
	<div id="displayPiano">
	</div>
  <pre style="display:none" id="fileContent"></pre>

	<script>
	function editDownload(){
		let link = document.getElementById('downloadLink');
		link.download = 'sample.txt';
		let blob = new Blob([document.getElementById('fileContent').textContent + ""], {type: 'text/plain'});
		link.href = URL.createObjectURL(blob);
	}

	function init(){
	  document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
		displayPiano();
		Synth.setSampleRate(20000);
		Synth.setVolume(0.4);
	}

	window.addEventListener("resize", displayPiano);
	function displayPiano(){
			var displayPiano = document.getElementById('displayPiano');
			displayPiano.innerHTML = "";
			var width = window.innerWidth * 0.8 - 2 * 3 * 14;
			var height = width * 4 / 35;
			var svg = "";
			var pieces = 35;
			var start = 5;
			var end = 5;
			var lineWidth = 1;
			var pianoPieceHeight = height - start - end - lineWidth * 2;
			var pianoPieceWidth = (width - start - end) / pieces - lineWidth * 2;
			var keyNote = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

			svg += '<svg id="keyboard" height="'+height+'px" width="'+width+'px">';
			for(i = 0; i < pieces; i++){
				svg += '<polygon id="key_'+keyNote[i%7]+'_'+Math.floor(i/7+2)+'" onClick="pressKey(this.id)" points="';
				svg += start + pianoPieceWidth * i;	//x1
				svg += ",";
				svg += start + pianoPieceHeight * (i % 2);	//y1
				svg += " ";
				svg += start + pianoPieceWidth * (i + 1);	//x2
				svg += ",";
				svg += start + pianoPieceHeight * (i % 2);	//y1
				svg += " ";
				svg += start + pianoPieceWidth * (i + 1);	//x2
				svg += ",";
				svg += start + pianoPieceHeight * ((i + 1) % 2);	//y2
				svg += " ";
				svg += start + pianoPieceWidth * i;	//x1
				svg += ",";
				svg += start + pianoPieceHeight * ((i + 1) % 2);	//y2
				svg += '" class="whiteKey" style="fill:#ffffff;stroke:#000000;stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
			}

			var blackNum = [1, 2, 4, 5, 6];
			var blackKeyNote = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
			for(i = 0; i < pieces; i++){
					if(blackNum.includes(i % 7 + 1)){
							svg += '<polygon id="key_'+blackKeyNote[i%7]+'_'+Math.floor(i/7+2)+'" onClick="pressKey(this.id)" points="';
							svg += start + pianoPieceWidth * (i + 0.75);	//x1
							svg += ",";
							svg += start + pianoPieceHeight * (i % 2) * 2 / 3;	//y1
							svg += " ";
							svg += start + pianoPieceWidth * (i + 0.75 + 0.5);	//x2
							svg += ",";
							svg += start + pianoPieceHeight * (i % 2) * 2 / 3;	//y1
							svg += " ";
							svg += start + pianoPieceWidth * (i + 0.75 + 0.5);	//x2
							svg += ",";
							svg += start + pianoPieceHeight * ((i + 1) % 2) * 2 / 3;	//y2
							svg += " ";
							svg += start + pianoPieceWidth * (i + 0.75);	//x1
							svg += ",";
							svg += start + pianoPieceHeight * ((i + 1) % 2) * 2 / 3;	//y2
							svg += '" class="blackKey" style="fill:#000000;stroke:#ffffff;stroke-width:'+lineWidth+';fill-rule:nonzero;" />';
					}
			}

			svg += '</svg>';
			displayPiano.innerHTML = svg;
	}

	function pressKey(id){
			var idArr = id.split('_');
			playOneNote(idArr[1], idArr[2], 2, 0);
	}

	function handleFileSelect(event){
	  const reader = new FileReader()
	  reader.onload = handleFileLoad;
		if(event.target.files.length > 0){
		  reader.readAsText(event.target.files[0]);
		}
	}

	function handleFileLoad(event){
	  document.getElementById('fileContent').textContent = event.target.result;
		loadText(event.target.result);
		editDownload();
		var myobj = document.getElementById("fileInput");
  	myobj.remove();
		document.getElementById("fileUploadDiv").innerHTML = '<input id="fileInput" type="file" name="file" />';
		init();
	}

	function loadFile(){
		loadText(document.getElementById('fileContent').textContent);
	}

	function loadSrc(type){
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function(){
					if(xmlhttp.status == 200 && xmlhttp.readyState == 4){
							var string = [];
							var txt = xmlhttp.responseText;
							loadText(txt.trim());
					}
				};
				xmlhttp.open("GET","./music/txt/" + type + ".txt",true);
				xmlhttp.send();
	}

	function loadText(text){
			var seperate = '//sample rate (4000-44100), volume, speed';
			var speed = 1;
			if(text.includes(seperate)){
					var headerFooterArr = text.split(seperate);
					if(headerFooterArr.length == 2){
							var headerArr = headerFooterArr[0].trim().split(",");
							if(headerArr.length == 3){
									Synth.setSampleRate(headerArr[0].trim());
									Synth.setVolume(headerArr[1].trim());
									speed = headerArr[2].trim();
							}
							text = headerFooterArr[1].trim();
					}
			}

			var noteArr = text.split(',');
			var startTime = 500;
			var addTime = 0;
			for(i = 0; i < noteArr.length; i++){
					var tempArr = noteArr[i].split('_');
					if(tempArr.length == 4){

							temp_3 = tempArr[3];
							if(tempArr[3].includes("/")){
								var divideArr = tempArr[3].split("/");
								if(divideArr.length == 2){
									temp_3 = divideArr[0] / divideArr[1];
								}
							}
							startTime += addTime;
							addTime = temp_3 * (4000 / speed);
							playOneNote(tempArr[0].trim(), tempArr[1], tempArr[2], startTime);
					}
			}

			Synth.setSampleRate(20000);
			Synth.setVolume(0.4);
	}

	function playOneNote(note, octave, duration, startTime){
			var note = document.getElementById("key_"+note+"_"+octave);
			note.classList.add("pressed");
			setTimeout(function() {
					note.classList.remove("pressed");
			}, duration);

			setTimeout(function() {
						var piano = Synth.createInstrument('piano');
						piano.play(note, octave, duration); // plays C4 for 2s using the 'piano' sound profile
			}, startTime);
	}
	</script>

	<ul id="foot">
		</br>
		<li>Â© Copyright 2020. All Rights Reserved.</li>
	</ul></br>
</body>
</html>
