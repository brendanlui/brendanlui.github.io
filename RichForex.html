<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
	<link id="stylecall1" rel="stylesheet" href="/css/academic_style.css" />
	<link id="stylecall2" rel="stylesheet" href="/css/logo_dadiu.css" />
	<link id="stylecall3" rel="stylesheet" href="/css/inputButton.css" />
	<link rel="icon"
	  type="image/png"
	  href="/img/d01.png">
	  <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.scrollTo.js"></script>
</head>

<title>Dadiu | Rich Forex Settlement</title>

<body onload="">
	<div id="head">
		<div id="logo">
			<img src="/img/dadiu.png" alt="dai01" class="logo_dadiu">
		</div>
	</div>

	<link rel="stylesheet" href="/css/responsive_bar_style.css">
	<div class="topnav" id="myTopnav">
	  <a href="/">Home</a>
	</div>

	<div>
		<style>
			/* The container */
			.container {
  		display: block;
			position: relative;
			padding-left: 35px;
			margin-bottom: 12px;
			cursor: pointer;
			font-size: 22px;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			}

			/* Hide the browser's default checkbox */
			.container input {
			position: absolute;
			opacity: 0;
			cursor: pointer;
			height: 0;
			width: 0;
			}

			/* Create a custom checkbox */
			.checkmark {
			position: absolute;
			top: 0;
			left: 0;
			height: 25px;
			width: 25px;
			background-color: #eee;
			}

			/* On mouse-over, add a grey background color */
			.container:hover input ~ .checkmark {
			background-color: #ccc;
			}

			/* When the checkbox is checked, add a blue background */
			.container input:checked ~ .checkmark {
			background-color: #2196F3;
			}

			/* Create the checkmark/indicator (hidden when not checked) */
			.checkmark:after {
			content: "";
			position: absolute;
			display: none;
			}

			/* Show the checkmark when checked */
			.container input:checked ~ .checkmark:after {
			display: block;
			}

			/* Style the checkmark/indicator */
			.container .checkmark:after {
			left: 9px;
			top: 5px;
			width: 5px;
			height: 10px;
			border: solid white;
			border-width: 0 3px 3px 0;
			-webkit-transform: rotate(45deg);
			-ms-transform: rotate(45deg);
			transform: rotate(45deg);
			}
			</style>

			<style>
			.label {
			  color: white;
			  padding: 4px;
			  font-family: Arial;
			}
			.info {background-color: #2196F3;} /* Blue */
			</style>

			<style>
			.buttonJp {
			  padding: 5px 0px;
			  text-align: center;
			  text-decoration: none;
			  display: inline-block;
			  font-size: 16px;
		  	border: thick solid white;
				width: 100%;
				font-weight: bold;
				overflow: hidden;
				height: 60px;
			}

			.buttonJp.active {
				background-color: #4d4d4d;
				color: white;
			}

			.btnFilter{
				width: 100%;
				text-overflow: ellipsis;
		  	overflow: hidden;
				height: 35px;
				padding: 1px 0px;
			  color: #6b6b6b;
			}
			</style>

			<input class="buttonJp btnFilter" type="button" id="calculate" value="Click to Calculate" onclick="Calculate()" />
			<h2 id="resultTitle" style="display:none;">Solution:</h2>
			<table id="finalResult"></table>

			<br><div class="divider1">&nbsp;</div>
			<h2>Monthly Status:</h2>
			<label class="container">Jan
			<input type="checkbox" id="month1" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month1text"></label>
			</label>
			<label class="container">Feb
			<input type="checkbox" id="month2" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month2text"></label>
			</label>
			<label class="container">Mar
			<input type="checkbox" id="month3" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month3text"></label>
			</label>
			<label class="container">Apr
			<input type="checkbox" id="month4" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month4text"></label>
			</label>
			<label class="container">May
			<input type="checkbox" id="month5" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month5text"></label>
			</label>
			<label class="container">Jun
			<input type="checkbox" id="month6" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month6text"></label>
			</label>
			<label class="container">Jul
			<input type="checkbox" id="month7" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month7text"></label>
			</label>
			<label class="container">Aug
			<input type="checkbox" id="month8" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month8text"></label>
			</label>
			<label class="container">Sep
			<input type="checkbox" id="month9" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month9text"></label>
			</label>
			<label class="container">Oct
			<input type="checkbox" id="month10" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month10text"></label>
			</label>
			<label class="container">Nov
			<input type="checkbox" id="month11" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month11text"></label>
			</label>
			<label class="container">Dec
			<input type="checkbox" id="month12" onclick="return false;">
			<span class="checkmark"></span>
			<label id="month12text"></label>
			</label>

			<br><div class="divider1">&nbsp;</div>
			<h2>User Input:</h2>
			<input type="text" id="numOfDept" placeholder="No. of Department in this Month" onchange="handleNumOfDept(this);" style="width:98%"/></h2>
			<div id="deptCond"></div>

			<input type="text" id="monthInput" onchange="handleMonth(this);" placeholder="Month"/>
			<input type="text" id="departmentFieldName" value = "Department" placeholder="Department Field Name"/>
			<input type="text" id="itemnoFieldName" value = "Item No." placeholder="Item No. Field Name"/>
			<input type="text" id="amtFieldName" value = "Amount" placeholder="Amount Field Name"/>

			<input type="file" id="fileUpload" />
			<input class="buttonJp btnFilter" type="button" id="upload" value="Click to Input" onclick="Upload()" /></br>
			<a href="./sample/itemAmountDetailPerMonth.xlsx" download>Click to Download Template</a>

			<br><div class="divider1">&nbsp;</div>
			<h2>Latest Excel Input Table:</h2>
			<table id="tableData"></table>

			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>
			<script type="text/javascript">
				var deptMap = new Map([]);
				var dept1Map = new Map([]);
				var dept2Map = new Map([]);
				var dept3Map = new Map([]);
				var dept4Map = new Map([]);
				var dept5Map = new Map([]);
				var dept6Map = new Map([]);
				var dept7Map = new Map([]);
				var dept8Map = new Map([]);
				var dept9Map = new Map([]);
				var dept10Map = new Map([]);
				var dept11Map = new Map([]);
				var dept12Map = new Map([]);
				deptMap.set(1, dept1Map);
				deptMap.set(2, dept2Map);
				deptMap.set(3, dept3Map);
				deptMap.set(4, dept4Map);
				deptMap.set(5, dept5Map);
				deptMap.set(6, dept6Map);
				deptMap.set(7, dept7Map);
				deptMap.set(8, dept8Map);
				deptMap.set(9, dept9Map);
				deptMap.set(10, dept10Map);
				deptMap.set(11, dept11Map);
				deptMap.set(12, dept12Map);

				function handleNumOfDept(input){

					if (isNaN(input.value)) input.value = 0;
					input.value = Math.round(input.value);
					if (input.value < 0) input.value = 0;
					if (input.value > 10) input.value = 10;

					document.getElementById("deptCond").innerHTML = "";
					for(i = 1; i <= input.value; i++){
						document.getElementById("deptCond").innerHTML += '<input type="text" id="dept' + i
													+ '" placeholder="Department Name '  + i
													+ '" style="width:49%"/>'
													+ '	<input type="text" id="dept' + i
													+ 'maxTtlAmt" onchange="handleAmt(this);" placeholder="Max Total Amount in this Month" style="width:48%"/>';
					}
					if(input.value == 0){
						input.value = "";
					}
				}

				function handleAmt(input) {
					if (isNaN(input.value)) input.value = "";
					if (input.value <= 0) input.value = "";
					if (input.value > 999999999999) input.value = 999999999999;
				}

				function handleMonth(input) {
					if (isNaN(input.value)) input.value = 1;
					if (input.value < 1) input.value = 1;
					if (input.value > 12) input.value = 12;
				}

		    function Upload() {
		        //Reference the FileUpload element.
		        var fileUpload = document.getElementById("fileUpload");

		        //Validate whether File is valid Excel file.
		        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
		        if (regex.test(fileUpload.value.toLowerCase())) {
		            if (typeof (FileReader) != "undefined") {
		                var reader = new FileReader();

		                //For Browsers other than IE.
		                if (reader.readAsBinaryString) {
		                    reader.onload = function (e) {
		                        ProcessExcel(e.target.result);
		                    };
		                    reader.readAsBinaryString(fileUpload.files[0]);
		                } else {
		                    //For IE Browser.
		                    reader.onload = function (e) {
		                        var data = "";
		                        var bytes = new Uint8Array(e.target.result);
		                        for (var i = 0; i < bytes.byteLength; i++) {
		                            data += String.fromCharCode(bytes[i]);
		                        }
		                        ProcessExcel(data);
		                    };
		                    reader.readAsArrayBuffer(fileUpload.files[0]);
		                }
		            } else {
		                alert("This browser does not support HTML5.");
		            }
		        } else {
		            alert("Please upload a valid Excel file.");
		        }
		    };

		    function ProcessExcel(data) {
		        //Read the Excel File data.
		        var workbook = XLSX.read(data, {
		            type: 'binary'
		        });

		        //Fetch the name of First Sheet.
		        var firstSheet = workbook.SheetNames[0];

		        //Read all rows from First Sheet into an JSON array.
		        var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);
						var keyNames = Object.keys(excelRows[0]);

						//create table
						createGrid(keyNames, excelRows);

						//comment later
						console.log("Field Name: " + keyNames);
						console.log("New Import Data: ");
						console.log(excelRows);
		    };

				//part of important data
				var monthMap = new Map([]);
				var month1Map = new Map([]);
				var month2Map = new Map([]);
				var month3Map = new Map([]);
				var month4Map = new Map([]);
				var month5Map = new Map([]);
				var month6Map = new Map([]);
				var month7Map = new Map([]);
				var month8Map = new Map([]);
				var month9Map = new Map([]);
				var month10Map = new Map([]);
				var month11Map = new Map([]);
				var month12Map = new Map([]);
				monthMap.set(1, month1Map);
				monthMap.set(2, month2Map);
				monthMap.set(3, month3Map);
				monthMap.set(4, month4Map);
				monthMap.set(5, month5Map);
				monthMap.set(6, month6Map);
				monthMap.set(7, month7Map);
				monthMap.set(8, month8Map);
				monthMap.set(9, month9Map);
				monthMap.set(10, month10Map);
				monthMap.set(11, month11Map);
				monthMap.set(12, month12Map);

				var deptList = [];
				var itemnoList = [];

				function createGrid(keyNames, excelRows) {

					//clear map with particular month
					var monthInput = parseInt(document.getElementById("monthInput").value);
					if(!monthInput){
						alert("Please input a Month.");
						return;
					}
					monthMap.get(monthInput).clear();

					//set table column field name
					var tableString = "";
					tableString = "";
					tableString += "<tr>";
					for(i = 0; i < keyNames.length; i++){
							var value = keyNames[i];
							if(!value){
								value = "";
							}
							tableString += "<th>" + keyNames[i] + "</th>";
					}
					tableString += "</tr>";

					//set data and UI
					var oldDept = "";
					for(i = 0; i < excelRows.length; i++){
						tableString += "<tr>";

						var thisDept = "";
						var thisItemno = "";
						var thisAmt = 0;

						for(j = 0; j < keyNames.length; j++){
							var newValue = excelRows[i][keyNames[j]];
							if(!newValue){
								newValue = "";
							}
							if(keyNames[j] == document.getElementById("departmentFieldName").value){
								if(newValue == ""){
									newValue = storeDept;
									excelRows[i][keyNames[j]] = storeDept;
								}else{
									storeDept = newValue;
								}
								thisDept = newValue;
								if(deptList.indexOf(thisDept) < 0){
									deptList.push(thisDept);
								}
							}else if(keyNames[j] == document.getElementById("itemnoFieldName").value){
								thisItemno = newValue;
								if(itemnoList.indexOf(thisItemno) < 0){
									itemnoList.push(thisItemno);
								}
							}else if(keyNames[j] == document.getElementById("amtFieldName").value){
								thisAmt = newValue;
							}
							tableString += "<td>" + newValue + "</td>";
						}

						var key = thisDept.trim().replace(/^\|+|\|+$/g, '') + "^.^" + thisItemno.trim().replace(/^\|+|\|+$/g, '');

						if(monthMap.get(monthInput).has(key)){
							monthMap.get(monthInput).set(key, parseFloat(monthMap.get(monthInput).get(key)) + parseFloat(thisAmt));
						}else{
							monthMap.get(monthInput).set(key, parseFloat(thisAmt));
						}

						tableString += "</tr>";
					}

					var numOfDept = document.getElementById("numOfDept").value;
					var tempStringMaxAmt = "";
					for(i = 1; i <= numOfDept; i++){
							var dept = document.getElementById("dept" + i).value;
							var totalAmt = document.getElementById("dept" + i + "maxTtlAmt").value;
							deptMap.get(monthInput).set(dept, totalAmt);
							tempStringMaxAmt += '<span class="label info">' + dept + ":" + totalAmt + '</span> ';
					}

					document.getElementById("month" + monthInput + "text").innerHTML = " - " + tempStringMaxAmt ;
					document.getElementById("month" + monthInput).checked = true;
					print12monthMap();
					document.getElementById("tableData").innerHTML = tableString;
				}

				function logMapElements(value, key, map) {
						console.log(`m[${key}] = ${value}`);
				}

				function print12monthMap(){
					for(i = 1; i <= 12; i++){
						console.log(i + ": ");
						monthMap.get(i).forEach(logMapElements);
					}
					console.log(deptMap);
				}

				var resultMap = new Map([]);
				var checkDept = "";
				var checkItemno = "";

				function getOriginalDept(value, key, map) {
						if(key.split("^.^")[1] == checkItemno && checkDept == ""){
							checkDept = key.split("^.^")[0];
						}
				}

				function Calculate(){
					itemnoList.forEach(function(itemnoItem, itemnoIndex, itemnoArray) {
						var settle = false;
						//try original
						checkItemno = itemnoItem;
						for(i = 1; i <= 12; i++){
							monthMap.get(i).forEach(getOriginalDept);
						}
						settle = checkOneYear(checkDept, checkItemno);
						checkDept = "";
						checkItemno = "";

						//try other
						deptList.forEach(function(deptItem, ideptIndex, deptArray) {
							if(settle){
								return;
							}
							settle = checkOneYear(deptItem, itemnoItem);
						});
					});
					console.log(resultMap);
					createResultGrid();
					document.getElementById("resultTitle").style.display = "block";
					document.getElementById("calculate").disabled = true;
					document.getElementById("calculate").value = "Done";
				}

				function checkOneYear(deptItem, itemnoItem){

					var settle = false;
					for(i = 1; i <= 12; i++){
							var value = 0;
							if(deptMap.get(i).has(deptItem) && monthMap.get(i).has(deptItem + "^.^" + itemnoItem)){
								value = parseFloat(monthMap.get(i).get(deptItem + "^.^" + itemnoItem));
								if(parseFloat(deptMap.get(i).get(deptItem)) < parseFloat(value)){
									var newKey = "";
									var tempMon = 0;
									deptList.forEach(function(deptItem2, ideptIndex2, deptArray2) {

												if(newKey != "" && tempMon == 12){
													return;
												}

												for(j = 1; j <= 12; j++){
														if(deptMap.get(j).has(deptItem2) && monthMap.get(j).has(deptItem + "^.^" + itemnoItem)){
															if((parseFloat(deptMap.get(j).get(deptItem2)) < parseFloat(monthMap.get(j).get(deptItem + "^.^" + itemnoItem)))){
																	tempMon = 0;
																	break;
															}else{
																tempMon++;
															}
														}else{
															tempMon++;
														}

														if(tempMon == 12 && j == 12){
															newKey = deptItem2 + "^.^" + itemnoItem;
														}
												}
									});

									if(newKey == "" || tempMon != 12){
											newKey = "ADDITIONAL_FEE" + "^.^" + itemnoItem;
									}

									resultMap.set(deptItem + "^.^" + itemnoItem, newKey);

									var oldDept = deptItem;
									var newDept = newKey.split("^.^")[0];

									for(j = 1; j <= 12; j++){
										if(deptMap.get(j).has(newDept)){
											deptMap.get(j).set(newDept, parseFloat(deptMap.get(j).get(newDept)) - parseFloat(value));
										}
									}
									settle = true;
									break;
								}
							}else {
								if(i == 12){
										for(j = 1; j <= 12; j++){
											if(deptMap.get(j).has(deptItem) && monthMap.get(j).has(deptItem + "^.^" + itemnoItem)){
												deptMap.get(j).set(deptItem, parseFloat(deptMap.get(j).get(deptItem)) - parseFloat(monthMap.get(j).get(deptItem + "^.^" + itemnoItem)));
											}
										}
										settle = true;
								}
							}
					}
					return settle;
				}

				var changeString = "";
				function getMapElements(value, key, map) {
						changeString += "<tr><td>" + key.split("^.^")[1] + "</td>"
												+ "<td>" + key.split("^.^")[0] + "</td>"
												+ "<td>" + value.split("^.^")[0] + "</td></tr>";
				}

				function createResultGrid(){
					//clear map with particular month
					document.getElementById("finalResult").innerHTML = "";

					//set table column field name
					var tableString = "";
					tableString = "";
					tableString += "<tr>";

					var deptField = document.getElementById("departmentFieldName").value;
					var itemnoField = document.getElementById("itemnoFieldName").value;
					tableString += "<th>" + itemnoField + "</th>"
										+ "<th>" + deptField + " (From)</th>"
										+ "<th>" + deptField + " (To)</th>";
					tableString += "</tr>";
					resultMap.forEach(getMapElements);
					tableString += changeString;
					document.getElementById("finalResult").innerHTML = tableString;
				}

			</script>

			<style>
			input[type=text] {
			  width: 24%;
			  padding: 12px 20px;
			  margin: 8px 0;
			  box-sizing: border-box;
			}

			#tableData, #finalResult {
			  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
			  border-collapse: collapse;
			  width: 100%;
			}

			#tableData td, #tableData th, #finalResult td, , #finalResult th {
			  border: 1px solid #ddd;
			  padding: 8px;
			}

			#tableData tr:nth-child(even), #finalResult tr:nth-child(even){background-color: #f2f2f2;}

			#tableData tr:hover , #finalResult tr:hover{background-color: #ddd;}

			#tableData th, #finalResult th{
			  padding-top: 12px;
			  padding-bottom: 12px;
				padding-left: 12px;
				padding-right: 12px;
			  text-align: left;
			  background-color: #737373;
			  color: white;
			}
			</style>
	</div>

	<ul id="foot">
		</br>
		<li>© Copyright 2019. All Rights Reserved.</li>
	</ul></br>
</body>
</html>
