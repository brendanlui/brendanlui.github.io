<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
	<link id="stylecall1" rel="stylesheet" href="/css/academic_style.css" />
	<link id="stylecall2" rel="stylesheet" href="/css/logo_dadiu.css" />
	<link id="stylecall3" rel="stylesheet" href="/css/inputButton.css" />
	<link id="stylecall4" rel="stylesheet" href="/css/numberKey.css" />
	<link rel="icon"
	  type="image/png"
	  href="/img/d01.png">
	  <script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
	  <script type="text/javascript" src="/js/jquery.scrollTo.js"></script>

</head>

<title>Dadiu | RSA</title>

<body onload="init()">
	<div id="head">
		<div id="logo">
			<a href="/"><img src="/img/dadiu.png" alt="dai01" class="logo_dadiu"></a>
		</div>
	</div>

	<link rel="stylesheet" href="/css/responsive_bar_style.css">
	<div class="topnav" id="myTopnav">
	  <a href="/">Home</a>
	</div>

	<!--TODO-->
	<div id="displayNumberBar">
	</div>

	<script>
	var publicKey_n = 0;
	var publicKey_e = 0;
	// var testingNum = BigInt(Math.floor(Math.random() * Math.floor(Math.pow(2, 53))) + '');
	var testingNum = 173;

	function init(){
			//printKey(100, 999);
			//printKey(20, 99);
			loadPublicKey();
			displayNumberBar();
	}

	var encryTyped = 0;
	var inputNum = '';
	window.addEventListener("resize", displayNumberBar);
	function displayNumberBar(){
			var displayNumberBar = document.getElementById('displayNumberBar');
			displayNumberBar.innerHTML = "";
			//var width = window.innerWidth * 0.8;
			var width = Math.round((document.getElementById("displayNumberBar").clientWidth + Number.EPSILON) * 1000) / 1000;
			var pieces = 3;
			var height = Math.round((width * 4 / pieces + Number.EPSILON) * 1000) / 1000;
			var svg = "";
			var start_x = 5;
			var start_y = 5;
			var end = 5;
			var lineWidth = 4;
			var numberPieceHeight = Math.round(((height - start_y - end) / (pieces + 1) + Number.EPSILON) * 1000) / 1000;
			var numberPieceWidth = Math.round(((width - start_x - end) / pieces + Number.EPSILON) * 1000) / 1000;

			svg += '<svg id="keyboard0" height="'+(height + height/8)+'px" width="'+width+'px">';
			for(i = 0; i < pieces * 2; i++){
				svg += '<polygon id="key_display_'+(i+1)+'" points="';
				svg += Math.round((start_x + numberPieceWidth / 2 * i + Number.EPSILON) * 1000) / 1000;	//x1
				svg += ",";
				svg += Math.round((start_y + numberPieceHeight / 2 * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
				svg += " ";
				svg += Math.round((start_x + numberPieceWidth / 2 * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
				svg += ",";
				svg += Math.round((start_y + numberPieceHeight / 2 * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
				svg += " ";
				svg += Math.round((start_x + numberPieceWidth / 2 * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
				svg += ",";
				svg += Math.round((start_y + numberPieceHeight / 2 * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
				svg += " ";
				svg += Math.round((start_x + numberPieceWidth / 2 * i + Number.EPSILON) * 1000) / 1000;	//x1
				svg += ",";
				svg += Math.round((start_y + numberPieceHeight / 2 * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
				svg += '" class="encryDisplay" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

  			svg += '<text id="encry_'+(i+1)+'" x="'
						+ Math.round((start_x + numberPieceWidth / 2 * (2 * i + 1) /2 + Number.EPSILON) * 1000) / 1000
						+ '" y="'
						+ Math.round((start_y + numberPieceHeight / 2 * ((i % 2) + ((i + 1) % 2)) / 2+ Number.EPSILON) * 1000) / 1000
						+ '" class="encryText"></text>';
			}
			start_y += numberPieceHeight / 2;

			for(h = 0; h < 4; h++){
					for(i = 0; i < pieces; i++){

						var displayText = ((i+1)+h*3);
						var pressKeyAble = true;
						if(displayText == 10){
								pressKeyAble = false;
								displayText = '';
						}else if(displayText == 11){
								displayText = 0;
						}else if(displayText == 12){
								displayText = "<-";
						}

						svg += '<polygon id="key_num_' + displayText + '" '
								+ (pressKeyAble ? 'onClick="pressKey(this.id)"' : '')
								+' points="';
						svg += Math.round((start_x + numberPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
						svg += ",";
						svg += Math.round((start_y + numberPieceHeight * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
						svg += " ";
						svg += Math.round((start_x + numberPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
						svg += ",";
						svg += Math.round((start_y + numberPieceHeight * (i % 2) + Number.EPSILON) * 1000) / 1000;	//y1
						svg += " ";
						svg += Math.round((start_x + numberPieceWidth * (i + 1) + Number.EPSILON) * 1000) / 1000;	//x2
						svg += ",";
						svg += Math.round((start_y + numberPieceHeight * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
						svg += " ";
						svg += Math.round((start_x + numberPieceWidth * i + Number.EPSILON) * 1000) / 1000;	//x1
						svg += ",";
						svg += Math.round((start_y + numberPieceHeight * ((i + 1) % 2) + Number.EPSILON) * 1000) / 1000;	//y2
						svg += '" class="numKey" style="stroke-width:'+lineWidth+';fill-rule:nonzero;" />';

  					svg += '<text id="key_text_' + displayText + '" onClick="pressKey(this.id)" x="'
								+ Math.round((start_x + numberPieceWidth * (2 * i + 1) / 2 + Number.EPSILON) * 1000) / 1000
								+ '" y="'
								+ Math.round((start_y + numberPieceHeight * ((i % 2) + ((i + 1) % 2)) / 2 + Number.EPSILON) * 1000) / 1000
								+ '" class="keyText">'
								+ displayText
								+ '</text>';
					}
					start_y += numberPieceHeight;
			}
			svg += '</svg>';

			displayNumberBar.innerHTML = svg;
	}

	var keyText = document.getElementsByClassName("keyText");
	var numKey = document.getElementsByClassName("numKey");
	function pressKey(id){
			var idArr = id.split('_');
			if(idArr.length == 3){
					var keySvg = document.getElementById('key_num_' + idArr[2]);
					keySvg.classList.add("pressed");
					keySvg.onclick = null;

					if(encryTyped == 6){
							keySvg.classList.remove("pressed");
							for(i = 0; i < keyText.length; i++){
								keyText[i].onclick = null;
							}
							for(i = 0; i < numKey.length; i++){
								numKey[i].onclick = null;
							}

							setTimeout(function() {
											if(isKeyCorrect(parseInt(inputNum))){
													//TODO
													console.log(true);
											}else{
													for(i = 1; i <= encryTyped; i++){
															document.getElementById('encry_' + i).innerHTML = "";
													}
													inputNum = "";
													encryTyped = 0;
													for(i = 0; i < keyText.length; i++){
														keyText[i].onClick = "pressKey(this.id)";
													}
													for(i = 0; i < numKey.length; i++){
														if(i != 10 - 1)
															numKey[i].onClick = "pressKey(this.id)";
													}
													console.log(false);
											}
							}, 200);
					}else{

							if(idArr[2] == '<-'){
									inputNum = inputNum.substring(0, inputNum.length - 1);
									document.getElementById('encry_' + encryTyped).innerHTML = "";
									encryTyped--;
							}else{
									inputNum += idArr[2];
									encryTyped++;
									document.getElementById('encry_' + encryTyped).innerHTML = ".";
							}

							setTimeout(function() {
										keySvg.classList.remove("pressed");
										keySvg.disabled = false;
							}, 200);
					}

			}
	}

	function loadPublicKey(){
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function(){
				if(xmlhttp.status == 200 && xmlhttp.readyState == 4){
						var string = [];
						var txt = xmlhttp.responseText;
						var arr = txt.split('_');
						if(arr.length == 2){
								publicKey_n = arr[0];
								publicKey_e = arr[1];
								//console.log(isKeyCorrect(165581));
						}
				}
			};
			xmlhttp.open("GET","./rsa/publicKey.txt", true);
			xmlhttp.send();
	}

	function isKeyCorrect(privateKey_d){
			var leftHandSide = (((BigInt(testingNum) ** BigInt(publicKey_e)) % BigInt(publicKey_n)) ** BigInt(privateKey_d)) % BigInt(publicKey_n);
			var rightHandSide = BigInt(testingNum) % BigInt(publicKey_n);

			if(leftHandSide == rightHandSide){
					return true;
			}else{
					return false;
			}
	}

	function printKey(minP, maxP){
			var privateKey_d = BigInt(generatePrivateKey(minP, maxP));
			var leftHandSide = (((BigInt(testingNum) ** BigInt(publicKey_e)) % BigInt(publicKey_n)) ** BigInt(privateKey_d)) % BigInt(publicKey_n);
			var rightHandSide = BigInt(testingNum) % BigInt(publicKey_n);

			console.log(publicKey_n);
			console.log(publicKey_e);
			console.log(privateKey_d);
			console.log(leftHandSide == rightHandSide);
			console.log(leftHandSide);
			console.log(rightHandSide);
	}

	function generatePrivateKey(primeMinP, primeMaxP){
			var privateKey_d = 0;
			while(!isPrime(primeMinP)){
					primeMinP++;
			}

			while(true){
					var primeArr = primeFactorsTo(primeMinP, primeMaxP);
					if(primeArr.length >= 2){
							var temp_k = 2;
							var arrP1P2 = getRandom(primeArr, 2);
							publicKey_n = arrP1P2[0] * arrP1P2[1];
							var function_n = (arrP1P2[0] - 1) * (arrP1P2[1] - 1);
							var function_n_factorArr = factors(function_n);

							var publicKey_e_arr = primeFactorsTo(2, function_n);
							for(i = 2; i < publicKey_e_arr.length; i++){
									if(!function_n_factorArr.includes(publicKey_e_arr[i])){
											publicKey_e = publicKey_e_arr[i];
											break;
									}
							}
							privateKey_d = (temp_k * function_n + 1) / publicKey_e;
							if(Number.isInteger(privateKey_d)){
									break;
							}
					}
			}
			return privateKey_d;
	}

	function isPrime(num) {
		  for(var i = 2; i < num; i++)
		    if(num % i === 0) return false;
		  return num > 1;
	}

	function primeFactorsTo(min, max){
	    var store = [];
			var primes = [];

	    for (var i = 2; i <= max; ++i){
	        if (!store[i]){
							if(i >= min){
									primes.push(i);
							}
	            for (var j = i << 1; j <= max; j += i){
	                store[j] = true;
	            }
	        }
	    }
	    return primes;
	}

	function factors(n){
		 var num_factors = [], i;
		 for (i = 1; i <= Math.floor(Math.sqrt(n)); i += 1){
			  if (n % i === 0){
			   num_factors.push(i);
			   if (n / i !== i)
			    	num_factors.push(n / i);
			  }
		 }
		 num_factors.sort(function(x, y){
		     return x - y;
		 });  // numeric sort
		 return num_factors;
  }

	function getRandom(arr, n) {
	    var result = new Array(n),
	        len = arr.length,
	        taken = new Array(len);
	    if (n > len)
	        throw new RangeError("getRandom: more elements taken than available");
	    while (n--) {
	        var x = Math.floor(Math.random() * len);
	        result[n] = arr[x in taken ? taken[x] : x];
	        taken[x] = --len in taken ? taken[len] : len;
	    }
	    return result;
	}
	</script>

	<ul id="foot">
		</br>
		<li>© Copyright 2020. All Rights Reserved.</li>
	</ul></br>
</body>
</html>
